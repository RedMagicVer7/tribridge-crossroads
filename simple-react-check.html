<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React渲染检查器</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }
    .status.warning {
      background-color: #fff3cd;
      color: #856404;
      border-left-color: #ffc107;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }
    .step {
      margin-bottom: 20px;
      padding-left: 20px;
      border-left: 2px solid #ddd;
    }
    pre {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Courier New', Courier, monospace;
      border: 1px solid #e9ecef;
    }
    .instructions {
      background-color: #e3f2fd;
      padding: 20px;
      border-radius: 4px;
      margin-top: 30px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .console-output {
      background-color: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: 'Courier New', Courier, monospace;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .timestamp {
      color: #999;
      font-size: 0.8em;
      margin-right: 10px;
    }
    .log-info { color: #8be9fd; }
    .log-success { color: #50fa7b; }
    .log-error { color: #ff5555; }
    .log-warning { color: #ffb86c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>React渲染检查器</h1>
    
    <div class="status warning" id="initial-status">
      <strong>准备就绪</strong>: 点击下方按钮开始检查React应用渲染情况
    </div>
    
    <div class="step">
      <h3>1. 检查React应用服务器</h3>
      <button id="check-server-btn">检查服务器状态</button>
      <div class="console-output" id="server-output"></div>
    </div>
    
    <div class="step">
      <h3>2. 检查React应用内容</h3>
      <button id="check-react-btn">加载并检查React应用</button>
      <div class="console-output" id="react-output"></div>
    </div>
    
    <div class="step">
      <h3>3. 检查React渲染状态</h3>
      <button id="check-render-btn">检查渲染状态</button>
      <div class="console-output" id="render-output"></div>
      <pre id="debug-info"></pre>
    </div>
    
    <div class="instructions">
      <h3>使用说明</h3>
      <p>这个工具将帮助你检查React应用是否在浏览器中正确渲染。请按照以下步骤操作：</p>
      <ol>
        <li>确保React应用预览服务器正在运行（http://localhost:4173/）</li>
        <li>点击"检查服务器状态"按钮，确认服务器正常响应</li>
        <li>点击"加载并检查React应用"按钮，让工具尝试加载React应用</li>
        <li>点击"检查渲染状态"按钮，查看React是否成功渲染了内容</li>
        <li>查看下方的调试信息，了解详细的渲染状态</li>
      </ol>
      <p><strong>提示</strong>：如果检查过程中出现问题，请打开浏览器控制台查看详细的错误信息。</p>
    </div>
  </div>

  <script>
    // 全局变量
    let reactAppFrame = null;
    let checkInterval = null;
    const SERVER_URL = 'http://localhost:4173/';
    const MAX_CHECK_ATTEMPTS = 10;
    let checkAttempts = 0;
    
    // 日志工具函数
    function logToConsole(outputElementId, message, type = 'info') {
      const outputElement = document.getElementById(outputElementId);
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `<span class="timestamp">${timestamp}</span><span class="log-${type}">${message}</span>`;
      outputElement.innerHTML += logLine + '\n';
      outputElement.scrollTop = outputElement.scrollHeight;
    }
    
    // 更新状态显示
    function updateStatus(message, type = 'warning') {
      const statusElement = document.getElementById('initial-status');
      statusElement.innerHTML = `<strong>${message}</strong>`;
      
      // 移除所有状态类
      statusElement.classList.remove('success', 'warning', 'error');
      // 添加新状态类
      statusElement.classList.add(type);
    }
    
    // 检查服务器状态
    document.getElementById('check-server-btn').addEventListener('click', async () => {
      const outputElement = document.getElementById('server-output');
      outputElement.innerHTML = '';
      
      logToConsole('server-output', '正在检查服务器状态: ' + SERVER_URL);
      
      try {
        const response = await fetch(SERVER_URL, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/html'
          }
        });
        
        if (response.ok) {
          logToConsole('server-output', `✅ 服务器响应成功 (状态码: ${response.status})`, 'success');
          updateStatus('服务器状态正常', 'success');
          
          const htmlContent = await response.text();
          const hasRootElement = htmlContent.includes('<div id="root">');
          const hasScriptTag = htmlContent.includes('<script type="module"');
          
          logToConsole('server-output', `HTML包含root元素: ${hasRootElement ? '✅ 是' : '❌ 否'}`);
          logToConsole('server-output', `HTML包含script标签: ${hasScriptTag ? '✅ 是' : '❌ 否'}`);
          
          if (hasRootElement && hasScriptTag) {
            logToConsole('server-output', '✅ HTML结构看起来正常', 'success');
          }
        } else {
          logToConsole('server-output', `❌ 服务器响应失败 (状态码: ${response.status})`, 'error');
          updateStatus('服务器状态异常', 'error');
        }
      } catch (error) {
        logToConsole('server-output', `❌ 无法连接到服务器: ${error.message}`, 'error');
        updateStatus('无法连接到服务器', 'error');
        logToConsole('server-output', '请确保预览服务器已启动并在' + SERVER_URL + '运行', 'warning');
      }
    });
    
    // 加载并检查React应用
    document.getElementById('check-react-btn').addEventListener('click', () => {
      const outputElement = document.getElementById('react-output');
      outputElement.innerHTML = '';
      
      logToConsole('react-output', '正在创建iframe加载React应用...');
      
      // 移除已存在的iframe（如果有）
      if (reactAppFrame) {
        document.body.removeChild(reactAppFrame);
        reactAppFrame = null;
      }
      
      // 创建新的iframe
      reactAppFrame = document.createElement('iframe');
      reactAppFrame.src = SERVER_URL;
      reactAppFrame.style.display = 'none';
      reactAppFrame.onload = () => {
        logToConsole('react-output', '✅ iframe已加载React应用', 'success');
        updateStatus('React应用已加载，等待渲染完成', 'success');
      };
      
      reactAppFrame.onerror = (error) => {
        logToConsole('react-output', `❌ iframe加载失败: ${error}`, 'error');
        updateStatus('React应用加载失败', 'error');
      };
      
      document.body.appendChild(reactAppFrame);
      logToConsole('react-output', 'iframe已添加到页面，等待加载完成...');
    });
    
    // 检查React渲染状态
    document.getElementById('check-render-btn').addEventListener('click', () => {
      const outputElement = document.getElementById('render-output');
      outputElement.innerHTML = '';
      const debugInfoElement = document.getElementById('debug-info');
      debugInfoElement.innerHTML = '';
      
      if (!reactAppFrame) {
        logToConsole('render-output', '❌ 请先点击"加载并检查React应用"按钮', 'error');
        return;
      }
      
      logToConsole('render-output', '正在检查React渲染状态...');
      
      try {
        // 尝试访问iframe的contentWindow
        const iframeWindow = reactAppFrame.contentWindow;
        const iframeDocument = reactAppFrame.contentDocument;
        
        if (!iframeWindow || !iframeDocument) {
          logToConsole('render-output', '❌ 无法访问iframe内容，可能存在跨域限制', 'error');
          return;
        }
        
        // 检查root元素
        const rootElement = iframeDocument.getElementById('root');
        if (rootElement) {
          logToConsole('render-output', '✅ 找到root元素', 'success');
          logToConsole('render-output', `root元素子节点数量: ${rootElement.children.length}`);
          
          if (rootElement.children.length > 0) {
            logToConsole('render-output', '✅ root元素包含内容，看起来React已渲染', 'success');
          } else {
            logToConsole('render-output', '⚠️ root元素为空，React可能尚未渲染或渲染失败', 'warning');
          }
          
          // 尝试获取root元素的内容
          try {
            const rootContent = rootElement.innerHTML.substring(0, 200) + '...';
            logToConsole('render-output', `root元素内容样本: ${rootContent}`);
          } catch (e) {
            logToConsole('render-output', '⚠️ 无法获取root元素内容', 'warning');
          }
        } else {
          logToConsole('render-output', '❌ 未找到root元素', 'error');
        }
        
        // 检查我们在MinimalTest组件中设置的全局变量
        try {
          const reactTestSuccess = iframeWindow.reactTestSuccess;
          const lastRenderTime = iframeWindow.lastRenderTime;
          
          if (reactTestSuccess === true) {
            logToConsole('render-output', '✅ window.reactTestSuccess = true，React组件成功渲染！', 'success');
            updateStatus('React应用渲染成功！', 'success');
          } else {
            logToConsole('render-output', `⚠️ window.reactTestSuccess = ${reactTestSuccess}`, 'warning');
          }
          
          if (lastRenderTime) {
            logToConsole('render-output', `最后渲染时间: ${lastRenderTime}`);
          }
          
          // 显示调试信息
          const debugInfo = {
            reactTestSuccess: reactTestSuccess,
            lastRenderTime: lastRenderTime,
            rootElementExists: !!rootElement,
            rootElementHasChildren: rootElement ? rootElement.children.length > 0 : false,
            documentTitle: iframeDocument.title,
            url: iframeWindow.location.href
          };
          
          debugInfoElement.textContent = JSON.stringify(debugInfo, null, 2);
          
        } catch (e) {
          logToConsole('render-output', `⚠️ 无法访问iframe的window对象: ${e.message}`, 'warning');
          logToConsole('render-output', '这通常是由于浏览器的跨域安全限制导致的', 'warning');
          logToConsole('render-output', '请直接在浏览器中打开' + SERVER_URL + '并检查控制台', 'warning');
        }
        
      } catch (error) {
        logToConsole('render-output', `❌ 检查渲染状态时出错: ${error.message}`, 'error');
      }
    });
    
    // 初始状态
    window.addEventListener('load', () => {
      logToConsole('server-output', '工具已加载，请按照步骤开始检查');
    });
  </script>
</body>
</html>