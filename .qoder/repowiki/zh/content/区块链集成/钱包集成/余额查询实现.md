<cite>
**Referenced Files in This Document**   
- [walletService.ts](file://src/services/walletService.ts)
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx)
- [wagmi.tsx](file://src/config/wagmi.tsx)
</cite>

## 目录
1. [余额查询实现](#余额查询实现)
2. [核心组件分析](#核心组件分析)
3. [余额查询架构](#余额查询架构)
4. [详细组件分析](#详细组件分析)
5. [依赖关系分析](#依赖关系分析)
6. [错误处理机制](#错误处理机制)
7. [前端集成实现](#前端集成实现)

## 余额查询实现

本文档详细分析了TriBridge跨链支付平台中余额查询功能的实现。重点解析了`getStablecoinBalances`方法的技术细节，该方法通过`STABLECOIN_CONTRACTS`配置对象管理不同网络上的稳定币合约地址，并使用ethers.js库批量查询DAI和USDC等ERC20代币的余额。文档还涵盖了错误处理机制以及在前端组件`TransactionExecutor`中的集成实现。

## 核心组件分析

余额查询功能的核心实现位于`WalletService`类中，该类提供了与区块链交互的主要接口。`getStablecoinBalances`方法是余额查询的核心，它接收用户钱包地址和网络ID作为参数，返回指定网络上所有支持的稳定币余额。

**Section sources**
- [walletService.ts](file://src/services/walletService.ts#L79-L114)

## 余额查询架构

```mermaid
graph TD
A[前端组件] --> B[WalletService]
B --> C[STABLECOIN_CONTRACTS]
B --> D[ERC20_ABI]
B --> E[ethers.js Provider]
C --> F[Sepolia测试网]
C --> G[Ethereum主网]
F --> H[DAI合约]
F --> I[USDC合约]
G --> J[DAI合约]
G --> K[USDC合约]
E --> L[区块链节点]
B --> M[余额结果]
M --> A
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts#L12-L23)
- [walletService.ts](file://src/services/walletService.ts#L26-L38)

## 详细组件分析

### getStablecoinBalances方法分析

`getStablecoinBalances`方法实现了跨网络稳定币余额查询的核心逻辑。该方法首先验证提供者（provider）是否已初始化，然后根据传入的网络ID从`STABLECOIN_CONTRACTS`配置中获取相应的合约地址集合。

```mermaid
flowchart TD
Start([开始]) --> ValidateProvider["验证Provider初始化"]
ValidateProvider --> CheckNetwork["检查网络支持"]
CheckNetwork --> InitBalances["初始化余额数组"]
InitBalances --> LoopStart["遍历合约"]
LoopStart --> CreateContract["创建ethers合约实例"]
CreateContract --> BatchCall["批量调用balanceOf, decimals, symbol"]
BatchCall --> FormatBalance["格式化余额"]
FormatBalance --> AddToResult["添加到结果数组"]
AddToResult --> LoopCheck{"是否还有合约?"}
LoopCheck --> |是| LoopStart
LoopCheck --> |否| ReturnResult["返回余额结果"]
ReturnResult --> End([结束])
style ValidateProvider fill:#f9f,stroke:#333
style CheckNetwork fill:#f9f,stroke:#333
style ReturnResult fill:#bbf,stroke:#333
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts#L79-L114)

### STABLECOIN_CONTRACTS配置对象

`STABLECOIN_CONTRACTS`是一个静态配置对象，用于存储不同网络上DAI和USDC稳定币的合约地址。该配置支持Ethereum Sepolia测试网（网络ID 11155111）和Ethereum主网（网络ID 1）。

```mermaid
erDiagram
STABLECOIN_CONTRACTS {
int networkId PK
string DAI
string USDC
}
STABLECOIN_CONTRACTS ||--o{ Sepolia : "11155111"
STABLECOIN_CONTRACTS ||--o{ EthereumMainnet : "1"
class Sepolia {
DAI: 0x6819...D574
USDC: 0xda9d...f53f
}
class EthereumMainnet {
DAI: 0x6B17...1d0F
USDC: 0xA0b8...5C7D
}
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts#L12-L23)

### ERC20标准方法调用

余额查询功能依赖于ERC20标准的三个核心方法：`balanceOf`、`decimals`和`symbol`。这些方法通过ethers.js库的`Contract`类进行调用，并使用`Promise.all`进行批量执行以提高效率。

```mermaid
sequenceDiagram
participant Client as 前端应用
participant WalletService as WalletService
participant Contract as ethers.Contract
participant Blockchain as 区块链网络
Client->>WalletService : getStablecoinBalances(address, networkId)
WalletService->>WalletService : 验证Provider和网络
WalletService->>Contract : new Contract(合约地址, ERC20_ABI, provider)
Contract->>Blockchain : balanceOf(address)
Contract->>Blockchain : decimals()
Contract->>Blockchain : symbol()
Blockchain-->>Contract : 返回余额、精度、符号
Contract-->>WalletService : 返回查询结果
WalletService->>WalletService : 格式化余额
WalletService-->>Client : 返回格式化后的余额数组
Note over Contract,Blockchain : 使用Promise.all并行调用三个方法
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts#L26-L38)

**Section sources**
- [walletService.ts](file://src/services/walletService.ts#L79-L114)

## 依赖关系分析

```mermaid
graph LR
A[TransactionExecutor] --> B[WalletService]
B --> C[STABLECOIN_CONTRACTS]
B --> D[ERC20_ABI]
B --> E[ethers]
B --> F[wagmi]
C --> G[Sepolia]
C --> H[Ethereum]
style A fill:#f96,stroke:#333
style B fill:#69f,stroke:#333
style C fill:#9f6,stroke:#333
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts)
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx)
- [wagmi.tsx](file://src/config/wagmi.tsx)

## 错误处理机制

余额查询功能实现了多层次的错误处理机制。在`getStablecoinBalances`方法中，首先检查Provider是否已初始化，然后验证网络是否受支持。在查询每个代币余额时，使用try-catch块捕获可能的异常，并在控制台记录错误信息，但不会中断其他代币的查询。

```mermaid
flowchart TD
A[开始查询] --> B{Provider已初始化?}
B --> |否| C[抛出错误: Provider未初始化]
B --> |是| D{网络受支持?}
D --> |否| E[抛出错误: 网络不支持]
D --> |是| F[遍历每个合约]
F --> G[创建合约实例]
G --> H[批量调用ERC20方法]
H --> I{调用成功?}
I --> |是| J[格式化并添加到结果]
I --> |否| K[记录错误, 继续下一个]
K --> L{还有合约?}
J --> L
L --> |是| F
L --> |否| M[返回结果]
M --> N[结束]
style C fill:#f66,stroke:#333
style E fill:#f66,stroke:#333
style K fill:#f96,stroke:#333
```

**Diagram sources**
- [walletService.ts](file://src/services/walletService.ts#L79-L114)

## 前端集成实现

余额查询功能在`TransactionExecutor`前端组件中得到集成应用。该组件在执行交易前调用`getStablecoinBalances`方法检查用户余额，确保有足够的资金完成交易。

```mermaid
sequenceDiagram
participant User as 用户
participant UI as TransactionExecutor UI
participant WalletService as WalletService
participant Blockchain as 区块链网络
User->>UI : 填写交易表单
UI->>UI : 显示执行按钮
User->>UI : 点击执行交易
UI->>WalletService : getStablecoinBalances(地址, 网络ID)
WalletService->>Blockchain : 查询DAI和USDC余额
Blockchain-->>WalletService : 返回余额
WalletService-->>UI : 返回余额数组
UI->>UI : 检查余额是否足够
alt 余额充足
UI->>UI : 继续交易流程
else 余额不足
UI->>User : 显示错误信息
end
Note over WalletService,Blockchain : 余额检查是交易执行的关键前置步骤
```

**Diagram sources**
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx#L150-L170)

**Section sources**
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx)