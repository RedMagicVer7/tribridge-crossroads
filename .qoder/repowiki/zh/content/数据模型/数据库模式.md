# 数据库模式

<cite>
**Referenced Files in This Document**   
- [database.ts](file://backend/src/services/database.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心表结构](#核心表结构)
3. [实体关系图](#实体关系图)
4. [字段业务含义](#字段业务含义)
5. [索引策略与查询优化](#索引策略与查询优化)
6. [表初始化与版本管理](#表初始化与版本管理)
7. [结论](#结论)

## 简介

本文档详细说明了TriBridge跨境支付系统中PostgreSQL数据库的模式设计。系统在`database.ts`文件中定义了五个核心数据表：用户表（users）、钱包表（wallets）、交易表（transactions）、KYC记录表（kyc_records）和清算订单表（settlement_orders）。这些表结构设计旨在支持复杂的跨境支付场景和严格的合规性要求，通过合理的字段定义、数据类型选择、主外键关系和约束条件，确保数据的完整性、一致性和安全性。

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L114-L222)

## 核心表结构

### 用户表 (users)

用户表存储系统注册用户的基本信息和认证状态。

| 字段名 | 数据类型 | 约束 | 业务含义 |
| :--- | :--- | :--- | :--- |
| id | SERIAL | PRIMARY KEY | 用户唯一标识符，自增主键 |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 用户邮箱，作为唯一登录凭证 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值，使用安全算法加密存储 |
| full_name | VARCHAR(255) | NOT NULL | 用户全名 |
| phone | VARCHAR(50) | - | 用户电话号码 |
| kyc_status | VARCHAR(50) | DEFAULT 'pending' | KYC认证状态，初始为'pending' |
| role | VARCHAR(50) | DEFAULT 'user' | 用户角色，如'user', 'admin' |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 记录创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 记录最后更新时间 |

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L118-L129)

### 钱包表 (wallets)

钱包表存储用户关联的区块链钱包地址信息。

| 字段名 | 数据类型 | 约束 | 业务含义 |
| :--- | :--- | :--- | :--- |
| id | SERIAL | PRIMARY KEY | 钱包唯一标识符，自增主键 |
| user_id | INTEGER | REFERENCES users(id) | 外键，关联用户表id |
| name | VARCHAR(255) | NOT NULL | 钱包名称，如"主钱包"、"备用钱包" |
| address | VARCHAR(255) | NOT NULL | 区块链钱包地址 |
| chain | VARCHAR(50) | NOT NULL | 钱包所属区块链网络，如'ethereum', 'tron' |
| is_default | BOOLEAN | DEFAULT false | 是否为默认钱包 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 记录创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 记录最后更新时间 |

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L133-L144)

### 交易表 (transactions)

交易表记录所有用户发起的链上交易和跨链操作。

| 字段名 | 数据类型 | 约束 | 业务含义 |
| :--- | :--- | :--- | :--- |
| id | SERIAL | PRIMARY KEY | 交易唯一标识符，自增主键 |
| user_id | INTEGER | REFERENCES users(id) | 外键，关联用户表id |
| type | VARCHAR(50) | NOT NULL | 交易类型，如'exchange', 'transfer' |
| status | VARCHAR(50) | NOT NULL | 交易当前状态 |
| from_chain | VARCHAR(50) | NOT NULL | 资金来源区块链网络 |
| to_chain | VARCHAR(50) | NOT NULL | 资金目标区块链网络 |
| from_token | VARCHAR(50) | NOT NULL | 转出代币类型，如'USDT', 'USDC' |
| to_token | VARCHAR(50) | NOT NULL | 转入代币类型 |
| amount | DECIMAL(20, 8) | NOT NULL | 交易金额，支持8位小数 |
| from_address | VARCHAR(255) | NOT NULL | 转出钱包地址 |
| to_address | VARCHAR(255) | NOT NULL | 转入钱包地址 |
| tx_hash | VARCHAR(255) | - | 区块链交易哈希 |
| block_number | BIGINT | - | 交易所在区块高度 |
| confirmations | INTEGER | DEFAULT 0 | 交易确认数 |
| fee | DECIMAL(20, 8) | - | 交易手续费 |
| gas_used | BIGINT | - | 实际消耗的Gas |
| exchange_rate | DECIMAL(20, 8) | - | 交易执行时的汇率 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 交易创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 交易记录最后更新时间 |
| completed_at | TIMESTAMP | - | 交易完成时间 |

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L147-L170)

### KYC记录表 (kyc_records)

KYC记录表存储用户的合规性认证详细信息。

| 字段名 | 数据类型 | 约束 | 业务含义 |
| :--- | :--- | :--- | :--- |
| id | SERIAL | PRIMARY KEY | KYC记录唯一标识符，自增主键 |
| user_id | INTEGER | REFERENCES users(id) | 外键，关联用户表id |
| provider | VARCHAR(50) | NOT NULL | KYC服务提供商，如'sumsub', 'onfido' |
| external_id | VARCHAR(255) | - | 服务提供商的外部ID |
| status | VARCHAR(50) | NOT NULL | 认证状态，如'pending', 'verified', 'rejected' |
| level | VARCHAR(50) | DEFAULT 'basic' | 认证等级，如'basic', 'advanced' |
| submitted_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 提交认证申请时间 |
| verified_at | TIMESTAMP | - | 认证通过时间 |
| rejected_at | TIMESTAMP | - | 认证被拒时间 |
| rejection_reason | TEXT | - | 拒绝原因说明 |
| documents | JSONB | - | 提交的文档信息，JSON格式存储 |
| personal_info | JSONB | - | 个人资料信息，JSON格式存储 |
| limits | JSONB | - | 交易限额配置，JSON格式存储 |

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L173-L188)

### 清算订单表 (settlement_orders)

清算订单表管理复杂的跨链清算流程。

| 字段名 | 数据类型 | 约束 | 业务含义 |
| :--- | :--- | :--- | :--- |
| id | SERIAL | PRIMARY KEY | 清算订单唯一标识符，自增主键 |
| user_id | INTEGER | REFERENCES users(id) | 外键，关联用户表id |
| type | VARCHAR(50) | NOT NULL | 订单类型，如'cross_chain_settlement' |
| status | VARCHAR(50) | NOT NULL | 订单当前状态 |
| from_chain | VARCHAR(50) | NOT NULL | 资金来源区块链网络 |
| to_chain | VARCHAR(50) | NOT NULL | 资金目标区块链网络 |
| from_token | VARCHAR(50) | NOT NULL | 转出代币类型 |
| to_token | VARCHAR(50) | NOT NULL | 转入代币类型 |
| amount | DECIMAL(20, 8) | NOT NULL | 订单金额，支持8位小数 |
| from_address | VARCHAR(255) | NOT NULL | 转出钱包地址 |
| to_address | VARCHAR(255) | NOT NULL | 转入钱包地址 |
| exchange_rate | DECIMAL(20, 8) | - | 订单执行汇率 |
| slippage | DECIMAL(5, 4) | - | 允许的价格滑点，最大0.9999（99.99%） |
| estimated_fee | DECIMAL(20, 8) | - | 预估手续费 |
| actual_fee | DECIMAL(20, 8) | - | 实际手续费 |
| steps | JSONB | - | 订单执行步骤，JSON格式存储 |
| transactions | JSONB | - | 关联的交易记录，JSON格式存储 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 订单创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 订单最后更新时间 |
| completed_at | TIMESTAMP | - | 订单完成时间 |
| expires_at | TIMESTAMP | - | 订单过期时间 |

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L192-L222)

## 实体关系图

```mermaid
erDiagram
users {
SERIAL id PK
VARCHAR(255) email UK
VARCHAR(255) password_hash
VARCHAR(255) full_name
VARCHAR(50) phone
VARCHAR(50) kyc_status
VARCHAR(50) role
TIMESTAMP created_at
TIMESTAMP updated_at
}
wallets {
SERIAL id PK
INTEGER user_id FK
VARCHAR(255) name
VARCHAR(255) address
VARCHAR(50) chain
BOOLEAN is_default
TIMESTAMP created_at
TIMESTAMP updated_at
}
transactions {
SERIAL id PK
INTEGER user_id FK
VARCHAR(50) type
VARCHAR(50) status
VARCHAR(50) from_chain
VARCHAR(50) to_chain
VARCHAR(50) from_token
VARCHAR(50) to_token
DECIMAL(20,8) amount
VARCHAR(255) from_address
VARCHAR(255) to_address
VARCHAR(255) tx_hash
BIGINT block_number
INTEGER confirmations
DECIMAL(20,8) fee
BIGINT gas_used
DECIMAL(20,8) exchange_rate
TIMESTAMP created_at
TIMESTAMP updated_at
TIMESTAMP completed_at
}
kyc_records {
SERIAL id PK
INTEGER user_id FK
VARCHAR(50) provider
VARCHAR(255) external_id
VARCHAR(50) status
VARCHAR(50) level
TIMESTAMP submitted_at
TIMESTAMP verified_at
TIMESTAMP rejected_at
TEXT rejection_reason
JSONB documents
JSONB personal_info
JSONB limits
}
settlement_orders {
SERIAL id PK
INTEGER user_id FK
VARCHAR(50) type
VARCHAR(50) status
VARCHAR(50) from_chain
VARCHAR(50) to_chain
VARCHAR(50) from_token
VARCHAR(50) to_token
DECIMAL(20,8) amount
VARCHAR(255) from_address
VARCHAR(255) to_address
DECIMAL(20,8) exchange_rate
DECIMAL(5,4) slippage
DECIMAL(20,8) estimated_fee
DECIMAL(20,8) actual_fee
JSONB steps
JSONB transactions
TIMESTAMP created_at
TIMESTAMP updated_at
TIMESTAMP completed_at
TIMESTAMP expires_at
}
users ||--o{ wallets : "拥有"
users ||--o{ transactions : "发起"
users ||--o{ kyc_records : "提交"
users ||--o{ settlement_orders : "创建"
```

**Diagram sources**
- [database.ts](file://backend/src/services/database.ts#L114-L222)

## 字段业务含义

### KYC状态流转

`kyc_status`字段在用户表中定义，初始值为'pending'，表示待认证状态。当用户提交KYC申请后，系统会创建一条`kyc_records`记录，并根据认证流程更新状态。状态流转如下：
- `pending` → `verified`：认证成功，用户获得相应交易权限
- `pending` → `rejected`：认证失败，用户需重新提交申请
- `verified` → `suspended`：在特定情况下（如可疑活动），账户可能被临时暂停

### 交易表中的多链标识

`from_chain`和`to_chain`字段是实现跨链支付的核心。它们明确标识了资金的来源和目标区块链网络，支持系统处理复杂的跨链交易。例如，一个从以太坊（Ethereum）到波场（Tron）的USDT转账，`from_chain`为'ethereum'，`to_chain`为'tron'。

### 汇率精度设计

`exchange_rate`字段在交易表和清算订单表中均定义为`DECIMAL(20, 8)`，这表示最多20位数字，其中小数点后8位。这种高精度设计对于稳定币兑换和跨境支付至关重要，可以精确计算微小的汇率差异，确保金融计算的准确性，避免因四舍五入导致的用户资金损失。

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L147-L170)
- [database.ts](file://backend/src/services/database.ts#L192-L222)

## 索引策略与查询优化

虽然表定义中未显式创建索引，但根据业务查询模式，应考虑以下索引策略：

1. **复合索引**：在`transactions`表上创建基于`user_id`和`created_at`的复合索引，以优化用户交易历史查询。这种索引能高效支持按用户和时间范围的查询，如"获取用户过去30天的所有交易"。

2. **状态索引**：在`transactions`和`settlement_orders`表上为`status`字段创建索引，以加速对特定状态（如'pending'、'failed'）的订单和交易的查询，这对于后台任务处理和监控至关重要。

3. **唯一约束索引**：`users`表的`email`字段上的`UNIQUE`约束会自动创建唯一索引，确保邮箱的唯一性，同时优化基于邮箱的登录查询。

4. **外键索引**：`REFERENCES`约束通常会自动在引用列上创建索引，如`wallets.user_id`，这优化了通过用户ID查找其所有钱包的查询性能。

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L114-L222)

## 表初始化与版本管理

### 表初始化流程

数据库表的初始化由`DatabaseService.initializeTables()`方法完成。该方法在应用启动时调用，遍历所有表的`CREATE TABLE IF NOT EXISTS`语句。`IF NOT EXISTS`子句确保了幂等性，即多次调用该方法不会导致错误，已存在的表将被跳过。此流程保证了数据库模式在服务启动时始终处于期望状态。

### 版本管理策略

当前实现中，表结构通过硬编码的SQL语句进行管理，这是一种简单的初始化策略。对于生产环境，建议采用更成熟的数据库迁移（Migration）工具，如`Knex.js`或`TypeORM`的迁移功能。迁移工具允许通过版本化的脚本（如`migration-001-add-users-table.js`）来管理模式变更，支持：
- **版本控制**：每个变更都有明确的版本号和描述。
- **可逆操作**：提供`up()`和`down()`方法，支持升级和回滚。
- **团队协作**：迁移脚本可纳入版本控制系统（如Git），便于团队协作和审计。

**Section sources**
- [database.ts](file://backend/src/services/database.ts#L114-L222)

## 结论

本文档详细阐述了TriBridge系统的PostgreSQL数据库模式。该模式通过精心设计的表结构、字段类型和关系约束，有效支持了跨境支付和合规性要求。`DECIMAL(20, 8)`的高精度数值类型确保了金融计算的准确性，而`JSONB`字段的使用则提供了存储复杂、非结构化数据的灵活性。尽管当前的初始化流程简单有效，但引入专业的数据库迁移工具将是未来提升系统可维护性和可靠性的关键步骤。