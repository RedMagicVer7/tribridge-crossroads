# 交易与区块链组件

<cite>
**本文档引用的文件**  
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx)
- [multiChainService.ts](file://backend/src/services/multiChainService.ts)
- [CurrencyExchange.tsx](file://src/components/Exchange/CurrencyExchange.tsx)
- [exchangeRateService.ts](file://src/services/exchangeRateService.ts)
- [OTCTrading.tsx](file://src/components/OTC/OTCTrading.tsx)
- [otcService.ts](file://backend/src/services/otcService.ts)
- [TransactionHistory.tsx](file://src/components/Transactions/TransactionHistory.tsx)
- [RecentTransactions.tsx](file://src/components/Dashboard/RecentTransactions.tsx)
- [LiquidityPoolManagement.tsx](file://src/components/LiquidityPool/LiquidityPoolManagement.tsx)
- [walletService.ts](file://src/services/walletService.ts)
- [transactionService.ts](file://src/services/transactionService.ts)
</cite>

## 目录
1. [交易执行器与多链服务集成](#交易执行器与多链服务集成)
2. [汇率服务与实时汇率获取](#汇率服务与实时汇率获取)
3. [场外交易组件与后端服务交互](#场外交易组件与后端服务交互)
4. [交易历史与最近交易数据管理](#交易历史与最近交易数据管理)
5. [流动性池管理与智能合约交互](#流动性池管理与智能合约交互)
6. [错误处理与性能优化](#错误处理与性能优化)

## 交易执行器与多链服务集成

`TransactionExecutor` 组件负责处理用户发起的链上交易，通过 `WalletService` 与用户钱包交互，并与后端 `multiChainService` 集成实现跨链交易。组件首先验证交易参数，检查用户余额，计算Gas费用，然后调用 `walletService.transferStablecoin` 发起交易。交易执行后，通过 `walletService.getTransactionStatus` 监听交易状态，确保交易成功确认。

```mermaid
sequenceDiagram
participant UI as "前端UI"
participant TE as "TransactionExecutor"
participant WS as "WalletService"
participant MCS as "multiChainService"
participant Blockchain as "区块链网络"
UI->>TE : 用户输入交易信息
TE->>TE : 验证交易参数
TE->>WS : getStablecoinBalances(地址, 网络)
WS->>Blockchain : 查询代币余额
Blockchain-->>WS : 返回余额
WS-->>TE : 返回余额信息
TE->>TE : 计算Gas费用
TE->>WS : transferStablecoin(交易请求)
WS->>MCS : 调用后端API
MCS->>Blockchain : 提交交易
Blockchain-->>MCS : 返回交易哈希
MCS-->>WS : 返回交易结果
WS-->>TE : 返回交易哈希
TE->>TE : 监听交易确认
TE->>WS : getTransactionStatus(交易哈希)
WS->>Blockchain : 查询交易状态
Blockchain-->>WS : 返回交易收据
WS-->>TE : 返回最终状态
TE->>UI : 显示交易结果
```

**图表来源**  
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx#L22-L388)
- [walletService.ts](file://src/services/walletService.ts#L63-L265)
- [multiChainService.ts](file://backend/src/services/multiChainService.ts#L48-L505)

**本节来源**  
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx#L22-L388)

## 汇率服务与实时汇率获取

`CurrencyExchange` 组件通过 `exchangeRateService` 获取实时汇率，支持从多个数据源获取价格。服务首先尝试从 CoinGecko API 获取数据，如果失败则尝试 Binance API，最后使用模拟数据作为后备。汇率数据会缓存30秒，避免频繁请求。组件还实现了自动刷新机制，每30秒更新一次汇率。

```mermaid
flowchart TD
A[CurrencyExchange组件] --> B{调用getExchangeRate}
B --> C[检查本地缓存]
C --> |命中| D[返回缓存汇率]
C --> |未命中| E[尝试CoinGecko API]
E --> |成功| F[解析并返回数据]
E --> |失败| G[尝试Binance API]
G --> |成功| H[解析并返回数据]
G --> |失败| I[返回模拟数据]
F --> J[更新缓存]
H --> J
I --> J
J --> K[返回汇率给组件]
```

**图表来源**  
- [CurrencyExchange.tsx](file://src/components/Exchange/CurrencyExchange.tsx#L15-L621)
- [exchangeRateService.ts](file://src/services/exchangeRateService.ts#L17-L281)

**本节来源**  
- [exchangeRateService.ts](file://src/services/exchangeRateService.ts#L17-L281)

## 场外交易组件与后端服务交互

`OTCTrading` 组件通过 `otcService` 与后端交互，实现场外交易订单的匹配和管理。用户选择货币对后，组件调用 `otcService.getOrderBook` 获取订单簿，显示买卖订单。当用户点击订单时，创建P2P交易，通过 `otcService.createTransaction` 在后端创建交易记录，并进入聊天流程。

```mermaid
sequenceDiagram
participant UI as "前端UI"
participant OTCT as "OTCTrading组件"
participant OTCService as "otcService"
participant Backend as "后端服务"
UI->>OTCT : 用户选择CNY/USDT
OTCT->>OTCService : getOrderBook(CNY, USDT)
OTCService->>Backend : 查询订单数据
Backend-->>OTCService : 返回订单列表
OTCService-->>OTCT : 返回订单簿
OTCT->>UI : 显示买卖订单
UI->>OTCT : 用户点击卖单
OTCT->>OTCT : 显示交易表单
UI->>OTCT : 输入金额并提交
OTCT->>OTCService : createTransaction(订单ID, 金额, 支付方式)
OTCService->>Backend : 创建P2P交易
Backend-->>OTCService : 返回交易ID
OTCService-->>OTCT : 返回交易对象
OTCT->>UI : 进入交易聊天界面
```

**图表来源**  
- [OTCTrading.tsx](file://src/components/OTC/OTCTrading.tsx#L57-L434)
- [otcService.ts](file://backend/src/services/otcService.ts#L84-L450)

**本节来源**  
- [otcService.ts](file://backend/src/services/otcService.ts#L84-L450)

## 交易历史与最近交易数据管理

`TransactionHistory` 和 `RecentTransactions` 组件通过 `transactionService` 管理交易数据。`TransactionHistory` 提供完整的交易列表，支持搜索、过滤和分页。`RecentTransactions` 显示最近的交易，支持加载更多。两个组件都从 `transactionService.getTransactionHistory` 获取数据，并实时更新。

```mermaid
classDiagram
class TransactionHistory {
+transactions : Transaction[]
+filteredTransactions : Transaction[]
+searchTerm : string
+statusFilter : string
+typeFilter : string
+loadTransactions() : void
+filterTransactions() : void
}
class RecentTransactions {
+allTransactions : Transaction[]
+visibleCount : number
+visibleTransactions : Transaction[]
+loadMoreTransactions() : void
}
class TransactionService {
+transactions : Transaction[]
+getTransactionHistory(userId?, limit?) : Transaction[]
+getTransactionById(id) : Transaction
}
TransactionHistory --> TransactionService : "获取历史"
RecentTransactions --> TransactionService : "获取最近交易"
```

**图表来源**  
- [TransactionHistory.tsx](file://src/components/Transactions/TransactionHistory.tsx#L39-L495)
- [RecentTransactions.tsx](file://src/components/Dashboard/RecentTransactions.tsx#L7-L201)
- [transactionService.ts](file://src/services/transactionService.ts#L52-L388)

**本节来源**  
- [TransactionHistory.tsx](file://src/components/Transactions/TransactionHistory.tsx#L39-L495)

## 流动性池管理与智能合约交互

`LiquidityPoolManagement` 组件允许用户投资和管理流动性池。用户可以查看不同风险等级的池子，投资后查看投资组合。组件通过 `walletService` 与智能合约交互，执行添加和移除流动性的操作。投资时需要用户钱包签名，确保资金安全。

```mermaid
flowchart TD
A[用户查看资金池] --> B[选择USD稳定币收益池]
B --> C[输入投资金额]
C --> D[调用invest函数]
D --> E[钱包请求签名]
E --> F[用户确认交易]
F --> G[发送交易到区块链]
G --> H[等待区块确认]
H --> I[更新用户投资记录]
I --> J[显示投资成功]
```

**图表来源**  
- [LiquidityPoolManagement.tsx](file://src/components/LiquidityPool/LiquidityPoolManagement.tsx#L52-L426)

**本节来源**  
- [LiquidityPoolManagement.tsx](file://src/components/LiquidityPool/LiquidityPoolManagement.tsx#L52-L426)

## 错误处理与性能优化

系统实现了全面的错误处理机制。交易失败时，`TransactionExecutor` 会回滚到失败步骤并显示错误信息。网络延迟时，`transactionService` 会重试请求。Gas费用通过 `multiChainService.getGasPrices` 动态估算。高频交易场景下，通过缓存、批量请求和虚拟滚动优化性能。

```mermaid
flowchart TD
A[交易失败] --> B[捕获错误]
B --> C[更新步骤状态为失败]
C --> D[显示错误提示]
D --> E[提供重试选项]
F[网络延迟] --> G[请求超时]
G --> H[自动重试3次]
H --> I[仍失败则提示用户]
J[性能优化] --> K[汇率缓存30秒]
J --> L[交易历史虚拟滚动]
J --> M[批量API请求]
```

**本节来源**  
- [TransactionExecutor.tsx](file://src/components/Blockchain/TransactionExecutor.tsx#L22-L388)
- [transactionService.ts](file://src/services/transactionService.ts#L52-L388)
- [exchangeRateService.ts](file://src/services/exchangeRateService.ts#L17-L281)