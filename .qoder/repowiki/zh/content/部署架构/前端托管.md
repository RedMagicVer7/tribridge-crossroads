# 前端托管

<cite>
**本文档中引用的文件**  
- [netlify.toml](file://netlify.toml)
- [vite.config.ts](file://vite.config.ts)
- [NETLIFY_REDEPLOY_TRIGGER.md](file://NETLIFY_REDEPLOY_TRIGGER.md)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md)
- [NETLIFY_FIX.md](file://NETLIFY_FIX.md)
- [NETLIFY_DEPLOY_FIX.md](file://NETLIFY_DEPLOY_FIX.md)
- [package.json](file://package.json)
- [src/main.tsx](file://src/main.tsx)
</cite>

## 目录

1. [简介](#简介)
2. [Netlify配置详解](#netlify配置详解)
3. [构建命令与发布目录](#构建命令与发布目录)
4. [环境变量配置](#环境变量配置)
5. [重定向规则与SPA路由支持](#重定向规则与spa路由支持)
6. [头部配置与MIME类型设置](#头部配置与mime类型设置)
7. [禁用Next.js插件的原因分析](#禁用nextjs插件的原因分析)
8. [CI/CD集成与重新部署触发](#cicd集成与重新部署触发)
9. [部署验证流程](#部署验证流程)
10. [常见部署问题及解决方案](#常见部署问题及解决方案)
11. [结论](#结论)

## 简介

本项目采用Netlify作为前端静态资源托管平台，结合Vite构建工具实现高效部署。通过`netlify.toml`配置文件定义构建流程、发布路径、环境变量、重定向规则和HTTP头部设置，确保前端应用在生产环境中稳定运行。同时，项目通过GitHub Actions实现CI/CD自动化流程，保障代码变更后能及时重新部署。

## Netlify配置详解

`netlify.toml`是Netlify平台的核心配置文件，用于定义构建行为、环境变量、路由规则和安全策略。该文件位于项目根目录，指导Netlify如何构建和部署前端应用。

**Section sources**
- [netlify.toml](file://netlify.toml#L1-L23)

## 构建命令与发布目录

在`netlify.toml`中，`[build]`部分定义了构建命令和发布目录：

```toml
[build]
  command = "vite build"
  publish = "dist"
```

- **command**: 指定构建命令为`vite build`，调用Vite的生产构建流程。
- **publish**: 指定构建输出目录为`dist`，该目录将被部署为静态资源。

此外，`vite.config.ts`中配置了构建输出路径：

```ts
build: {
  outDir: "dist",
}
```

确保Vite构建输出与Netlify发布目录一致。

**Section sources**
- [netlify.toml](file://netlify.toml#L1-L5)
- [vite.config.ts](file://vite.config.ts#L25-L28)

## 环境变量配置

`[build.environment]`部分定义了构建时所需的环境变量：

```toml
[build.environment]
  NODE_VERSION = "18"
  NETLIFY_NEXT_PLUGIN_SKIP = "true"
  NEXT_PRIVATE_TARGET = ""
  NEXT_TELEMETRY_DISABLED = "1"
```

- `NODE_VERSION`: 指定Node.js版本为18，确保构建环境一致性。
- `NETLIFY_NEXT_PLUGIN_SKIP`: 跳过Next.js插件自动检测，防止误判。
- `NEXT_PRIVATE_TARGET` 和 `NEXT_TELEMETRY_DISABLED`: 明确禁用Next.js相关功能，避免冲突。

这些变量确保构建环境干净，避免Netlify自动启用Next.js构建流程。

**Section sources**
- [netlify.toml](file://netlify.toml#L7-L11)

## 重定向规则与SPA路由支持

为支持单页应用（SPA）的客户端路由，Netlify通过`[[redirects]]`实现路径重写：

```toml
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

此规则将所有路径请求重定向到`/index.html`，由前端路由（如React Router）接管后续路由逻辑，确保刷新页面时仍能正确加载应用。

**Section sources**
- [netlify.toml](file://netlify.toml#L15-L19)

## 头部配置与MIME类型设置

`[[headers]]`用于设置特定资源的HTTP响应头，解决MIME类型识别问题：

```toml
[[headers]]
  for = "/manifest.webmanifest"
  [headers.values]
  Content-Type = "application/manifest+json"
```

此配置确保`manifest.webmanifest`文件以正确的MIME类型返回，避免浏览器解析PWA清单文件时出错。

**Section sources**
- [netlify.toml](file://netlify.toml#L21-L23)

## 禁用Next.js插件的原因分析

尽管项目未使用Next.js框架，但Netlify会根据文件结构（如`.next`目录）自动启用`@netlify/plugin-nextjs`插件。为避免误判，项目采取以下措施：

1. **删除`.next`目录**：防止Netlify检测到Next.js构建痕迹。
2. **禁用插件**：在`netlify.toml`中注释掉插件配置。
3. **环境变量控制**：设置`NETLIFY_NEXT_PLUGIN_SKIP = "true"`强制跳过插件。

这些措施确保Netlify以标准静态站点方式处理构建，避免插件干扰Vite构建流程。

**Section sources**
- [netlify.toml](file://netlify.toml#L13-L14)
- [NETLIFY_FIX.md](file://NETLIFY_FIX.md#L1-L8)
- [NETLIFY_DEPLOY_FIX.md](file://NETLIFY_DEPLOY_FIX.md#L1-L9)

## CI/CD集成与重新部署触发

项目通过GitHub Actions实现CI/CD自动化。当代码推送到主分支时，自动触发构建和部署流程。`NETLIFY_REDEPLOY_TRIGGER.md`文件用于手动触发重新部署：

```markdown
# Netlify重新部署触发文件

此文件用于触发Netlify的重新部署，确保最新的更改能够生效。

## 已实施的修复措施：

1. 更新了Vite配置中的base路径为相对路径('./')
2. 删除了.next目录以避免Netlify误判为Next.js项目
3. 确保netlify.toml配置正确
4. 所有更改已推送到GitHub
```

通过修改此文件并推送，可强制Netlify重新拉取代码并执行构建，解决缓存或配置未生效问题。

**Section sources**
- [NETLIFY_REDEPLOY_TRIGGER.md](file://NETLIFY_REDEPLOY_TRIGGER.md#L1-L9)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)

## 部署验证流程

部署完成后，需执行以下验证步骤：

1. **访问根路径**：确认`https://your-domain.com`能正常加载首页。
2. **测试SPA路由**：直接访问`https://your-domain.com/wallet`等客户端路由，验证重定向规则是否生效。
3. **检查资源加载**：确认`manifest.webmanifest`等静态资源MIME类型正确。
4. **查看构建日志**：在Netlify控制台检查构建输出，确认无错误。
5. **验证环境变量**：确保`NODE_VERSION`等环境变量正确应用。

**Section sources**
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)

## 常见部署问题及解决方案

### 构建失败
- **问题**：Node.js版本不匹配。
- **解决方案**：在`netlify.toml`中明确指定`NODE_VERSION = "18"`。

### 页面空白
- **问题**：路由未正确重定向。
- **解决方案**：确认`[[redirects]]`规则存在且`status = 200`。

### 路径错误
- **问题**：Vite的`base`路径未设为相对路径。
- **解决方案**：在`vite.config.ts`中设置`base: './'`。

### 缓存问题
- **问题**：旧版本资源被缓存。
- **解决方案**：修改`NETLIFY_REDEPLOY_TRIGGER.md`并推送以触发重新部署。

### MIME类型错误
- **问题**：`manifest.webmanifest`被识别为`text/plain`。
- **解决方案**：通过`[[headers]]`设置正确的`Content-Type`。

**Section sources**
- [NETLIFY_FIX.md](file://NETLIFY_FIX.md#L1-L8)
- [NETLIFY_DEPLOY_FIX.md](file://NETLIFY_DEPLOY_FIX.md#L1-L9)
- [vite.config.ts](file://vite.config.ts#L15-L17)

## 结论

通过精细化配置`netlify.toml`，本项目实现了高效、稳定的前端托管。关键配置包括Vite构建命令、SPA重定向规则、MIME类型头部设置以及Next.js插件的禁用策略。结合GitHub Actions的CI/CD流程，确保了代码变更能自动、可靠地部署到生产环境。部署验证和问题排查机制进一步保障了线上服务的可用性。