# 部署架构

<cite>
**本文档引用的文件**   
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [netlify.toml](file://netlify.toml)
- [nginx.conf](file://nginx.conf)
- [NETLIFY_REDEPLOY_TRIGGER.md](file://NETLIFY_REDEPLOY_TRIGGER.md)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md)
- [backend/src/index.ts](file://backend/src/index.ts)
- [backend/src/services/database.ts](file://backend/src/services/database.ts)
- [backend/src/services/redis.ts](file://backend/src/services/redis.ts)
</cite>

## 目录
1. [部署架构概述](#部署架构概述)
2. [容器化策略](#容器化策略)
3. [多服务编排](#多服务编排)
4. [前端托管配置](#前端托管配置)
5. [反向代理设置](#反向代理设置)
6. [CI/CD流程](#cicd流程)
7. [生产环境配置](#生产环境配置)
8. [高可用性设计](#高可用性设计)
9. [故障排查指南](#故障排查指南)

## 部署架构概述

本系统采用现代化的微服务架构，通过Docker容器化技术实现前后端分离部署。整体架构包含前端应用、后端API服务、PostgreSQL数据库、Redis缓存服务以及Nginx反向代理等多个组件，通过docker-compose进行统一编排管理。前端通过Netlify进行全球CDN托管，后端服务通过容器化部署确保环境一致性。Nginx作为反向代理服务器，负责负载均衡和SSL终止，为系统提供安全的HTTPS访问。

```mermaid
graph TB
subgraph "客户端"
Client[用户浏览器]
end
subgraph "边缘层"
Netlify[Netlify CDN]
Nginx[Nginx反向代理]
end
subgraph "应用层"
Frontend[前端应用]
Backend[后端API服务]
end
subgraph "数据层"
Postgres[PostgreSQL数据库]
Redis[Redis缓存]
end
Client --> Netlify
Netlify --> Nginx
Nginx --> Frontend
Nginx --> Backend
Backend --> Postgres
Backend --> Redis
style Client fill:#f9f,stroke:#333
style Netlify fill:#bbf,stroke:#333
style Nginx fill:#f96,stroke:#333
style Frontend fill:#9f9,stroke:#333
style Backend fill:#9f9,stroke:#333
style Postgres fill:#99f,stroke:#333
style Redis fill:#f99,stroke:#333
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L74)
- [nginx.conf](file://nginx.conf#L1-L78)

**Section sources**
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)

## 容器化策略

系统采用多阶段Docker构建策略，实现前后端分离的镜像构建。Dockerfile定义了三个构建阶段：前端构建器、后端构建器和运行时环境，有效减小最终镜像体积并提高安全性。

```mermaid
graph TD
A[Dockerfile] --> B[前端构建阶段]
A --> C[后端构建阶段]
A --> D[运行时阶段]
B --> E[复制前端包文件]
E --> F[安装前端依赖]
F --> G[复制源码]
G --> H[构建前端]
C --> I[复制后端包文件]
I --> J[安装后端依赖]
J --> K[复制源码]
K --> L[构建后端]
D --> M[复制生产依赖]
M --> N[从构建阶段复制前端]
N --> O[从构建阶段复制后端]
O --> P[创建非root用户]
P --> Q[设置健康检查]
Q --> R[启动应用]
style A fill:#f96,stroke:#333
style B fill:#9f9,stroke:#333
style C fill:#9f9,stroke:#333
style D fill:#9f9,stroke:#333
```

**Diagram sources**
- [Dockerfile](file://Dockerfile#L1-L72)

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L72)

## 多服务编排

通过docker-compose.yml文件定义了完整的多服务编排方案，包含前端、后端、数据库、缓存和反向代理五个核心服务，确保各组件协同工作。

```mermaid
graph TB
Compose[docker-compose.yml] --> Frontend[前端服务]
Compose --> Backend[后端服务]
Compose --> Postgres[PostgreSQL]
Compose --> Redis[Redis]
Compose --> Nginx[Nginx]
Frontend --> |构建上下文| .[当前目录]
Frontend --> |目标阶段| frontend-builder
Frontend --> |端口映射| 8080:8080
Frontend --> |环境变量| NODE_ENV=development
Backend --> |构建上下文| .[当前目录]
Backend --> |目标阶段| runtime
Backend --> |端口映射| 8000:8000
Backend --> |环境变量| NODE_ENV=production
Backend --> |依赖| Postgres
Backend --> |依赖| Redis
Backend --> |卷映射| logs:/app/logs
Postgres --> |镜像| postgres:15-alpine
Postgres --> |环境变量| POSTGRES_DB=tribridge
Postgres --> |端口映射| 5432:5432
Postgres --> |卷| postgres_data:/var/lib/postgresql/data
Redis --> |镜像| redis:7-alpine
Redis --> |端口映射| 6379:6379
Redis --> |卷| redis_data:/data
Nginx --> |镜像| nginx:alpine
Nginx --> |端口映射| 80:80,443:443
Nginx --> |卷映射| nginx.conf:/etc/nginx/nginx.conf
Nginx --> |依赖| Frontend
Nginx --> |依赖| Backend
style Compose fill:#f96,stroke:#333
style Frontend fill:#9f9,stroke:#333
style Backend fill:#9f9,stroke:#333
style Postgres fill:#99f,stroke:#333
style Redis fill:#f99,stroke:#333
style Nginx fill:#f96,stroke:#333
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L74)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L74)

## 前端托管配置

前端应用通过Netlify进行托管，通过netlify.toml配置文件定义了构建命令、发布目录和重定向规则，确保单页应用的正确路由处理。

```mermaid
flowchart TD
A[netlify.toml] --> B[构建配置]
A --> C[环境变量]
A --> D[重定向规则]
A --> E[头部设置]
B --> F[构建命令: vite build]
B --> G[发布目录: dist]
C --> H[NODE_VERSION: 18]
C --> I[NETLIFY_NEXT_PLUGIN_SKIP: true]
C --> J[NEXT_PRIVATE_TARGET: ""]
C --> K[NEXT_TELEMETRY_DISABLED: 1]
D --> L[/* 重定向到 /index.html]
D --> M[状态码: 200]
E --> N[/manifest.webmanifest]
N --> O[Content-Type: application/manifest+json]
style A fill:#f96,stroke:#333
style B fill:#9f9,stroke:#333
style C fill:#9f9,stroke:#333
style D fill:#9f9,stroke:#333
style E fill:#9f9,stroke:#333
```

**Diagram sources**
- [netlify.toml](file://netlify.toml#L1-L23)

**Section sources**
- [netlify.toml](file://netlify.toml#L1-L23)

## 反向代理设置

Nginx配置实现了反向代理功能，将前端静态资源和后端API请求分别路由到对应的上游服务，同时支持WebSocket连接，为实时通信提供支持。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Nginx as Nginx反向代理
participant Frontend as 前端服务
participant Backend as 后端服务
Client->>Nginx : HTTP请求 (http : //tribridge.pages.dev)
Nginx->>Nginx : 匹配location /
Nginx->>Frontend : proxy_pass http : //frontend : 8080
Frontend-->>Nginx : 前端资源
Nginx-->>Client : 返回前端内容
Client->>Nginx : API请求 (http : //tribridge.pages.dev/api/)
Nginx->>Nginx : 匹配location /api/
Nginx->>Backend : proxy_pass http : //backend : 8000
Backend-->>Nginx : API响应
Nginx-->>Client : 返回API数据
Client->>Nginx : WebSocket连接 (/socket.io/)
Nginx->>Nginx : 匹配location /socket.io/
Nginx->>Backend : 升级为WebSocket连接
Backend-->>Nginx : WebSocket响应
Nginx-->>Client : 建立WebSocket连接
Note over Nginx,Backend : Nginx处理SSL终止和负载均衡
```

**Diagram sources**
- [nginx.conf](file://nginx.conf#L1-L78)
- [docker-compose.yml](file://docker-compose.yml#L50-L74)

**Section sources**
- [nginx.conf](file://nginx.conf#L1-L78)

## CI/CD流程

系统的CI/CD流程通过GitHub Actions和Netlify集成实现自动部署，当代码推送到主分支时触发重新部署，确保最新更改及时生效。

```mermaid
flowchart LR
A[代码提交] --> B{推送到main分支?}
B --> |是| C[触发GitHub Actions]
B --> |否| D[代码审查]
C --> E[运行构建流程]
E --> F[执行测试]
F --> G{测试通过?}
G --> |是| H[构建Docker镜像]
G --> |否| I[通知失败]
H --> J[部署到生产环境]
J --> K[更新Netlify托管]
K --> L[发送部署通知]
M[NETLIFY_REDEPLOY_TRIGGER.md] --> N[部署修复措施]
N --> O[更新Vite配置路径]
N --> P[删除.next目录]
N --> Q[验证netlify.toml]
N --> R[推送更改]
style A fill:#f96,stroke:#333
style C fill:#f96,stroke:#333
style H fill:#f96,stroke:#333
style K fill:#f96,stroke:#333
style M fill:#f96,stroke:#333
```

**Diagram sources**
- [NETLIFY_REDEPLOY_TRIGGER.md](file://NETLIFY_REDEPLOY_TRIGGER.md#L1-L9)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)

**Section sources**
- [NETLIFY_REDEPLOY_TRIGGER.md](file://NETLIFY_REDEPLOY_TRIGGER.md#L1-L9)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)

## 生产环境配置

生产环境配置遵循最佳实践，通过环境变量管理敏感信息，实施日志收集和监控告警，确保系统安全稳定运行。

### 环境变量管理
```mermaid
flowchart TB
A[环境变量] --> B[数据库配置]
A --> C[区块链配置]
A --> D[认证服务]
A --> E[安全配置]
B --> F[DATABASE_URL]
B --> G[DB_HOST, DB_PORT]
B --> H[DB_USER, DB_PASSWORD]
C --> I[ETH_RPC_URL]
C --> J[TRON_RPC_URL]
C --> K[BSC_RPC_URL]
D --> L[SUMSUB_APP_TOKEN]
D --> M[ONFIDO_API_TOKEN]
D --> N[JWT_SECRET]
E --> O[NODE_ENV]
E --> P[PORT]
E --> Q[FRONTEND_URL]
style A fill:#f96,stroke:#333
style B fill:#9f9,stroke:#333
style C fill:#9f9,stroke:#333
style D fill:#9f9,stroke:#333
style E fill:#9f9,stroke:#333
```

### 日志收集与监控
```mermaid
flowchart LR
A[应用日志] --> B[前端日志]
A --> C[后端日志]
A --> D[数据库日志]
A --> E[Nginx日志]
B --> F[浏览器控制台]
C --> G[服务端日志文件]
D --> H[PostgreSQL日志]
E --> I[Nginx访问/错误日志]
F --> J[集中日志系统]
G --> J
H --> J
I --> J
J --> K[日志分析]
K --> L[错误告警]
K --> M[性能监控]
K --> N[安全审计]
style A fill:#f96,stroke:#333
style J fill:#f96,stroke:#333
```

**Section sources**
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)
- [docker-compose.yml](file://docker-compose.yml#L1-L74)

## 高可用性设计

系统通过容器健康检查、自动重启策略和备份恢复方案确保高可用性，最大限度减少服务中断时间。

### 健康检查与自动恢复
```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 运行中 : 启动成功
运行中 --> 健康 : 健康检查通过
运行中 --> 不健康 : 健康检查失败
不健康 --> 重启 : 自动重启策略
重启 --> 运行中 : 重启成功
重启 --> 故障 : 重启失败
故障 --> 告警 : 发送告警通知
告警 --> 人工干预 : 运维处理
note right of 健康
健康检查端点 : /health
检查间隔 : 30秒
超时 : 3秒
重试次数 : 3次
end note
```

### 备份与恢复方案
```mermaid
flowchart TB
A[定期备份] --> B[数据库备份]
A --> C[配置备份]
A --> D[应用数据备份]
B --> E[每日全量备份]
B --> F[每小时增量备份]
B --> G[备份到云存储]
C --> H[版本控制配置]
C --> I[环境变量备份]
D --> J[用户上传文件]
D --> K[交易记录]
L[灾难恢复] --> M[从备份恢复]
M --> N[数据库恢复]
N --> O[验证数据完整性]
O --> P[启动服务]
P --> Q[系统验证]
Q --> R[服务恢复]
style A fill:#f96,stroke:#333
style L fill:#f96,stroke:#333
```

**Diagram sources**
- [Dockerfile](file://Dockerfile#L70-L72)
- [backend/src/index.ts](file://backend/src/index.ts#L230-L258)

**Section sources**
- [Dockerfile](file://Dockerfile#L70-L72)
- [backend/src/index.ts](file://backend/src/index.ts#L230-L258)

## 故障排查指南

提供常见问题的解决方案，帮助快速定位和解决部署过程中可能遇到的问题。

### 容器启动失败
```mermaid
flowchart TD
A[容器启动失败] --> B{检查日志}
B --> C[查看docker-compose日志]
C --> D[常见问题]
D --> E[端口冲突]
E --> F[修改端口映射]
D --> G[依赖服务未启动]
G --> H[检查depends_on配置]
D --> I[环境变量缺失]
I --> J[验证环境变量]
D --> J[磁盘空间不足]
J --> K[清理磁盘空间]
D --> L[权限问题]
L --> M[检查文件权限]
style A fill:#f96,stroke:#333
```

### 网络连接问题
```mermaid
flowchart TD
A[网络连接问题] --> B{确定问题范围}
B --> C[容器间通信]
B --> D[外部访问]
C --> E[检查docker-compose网络]
E --> F[验证服务名称]
F --> G[使用服务名而非IP]
D --> H[检查端口映射]
H --> I[验证主机端口]
I --> J[检查防火墙设置]
C --> K[测试连接]
K --> L[使用docker exec测试]
L --> M[ping其他服务]
style A fill:#f96,stroke:#333
```

### SSL证书错误
```mermaid
flowchart TD
A[SSL证书错误] --> B{确定错误类型}
B --> C[证书过期]
B --> D[证书不匹配]
B --> E[证书链不完整]
C --> F[更新证书]
F --> G[使用Let's Encrypt]
G --> H[自动续期]
D --> I[验证域名匹配]
I --> J[更新证书SAN]
E --> K[包含完整证书链]
K --> L[添加中间证书]
M[Netlify托管] --> N[自动管理SSL]
N --> O[无需手动配置]
style A fill:#f96,stroke:#333
style M fill:#9f9,stroke:#333
```

**Section sources**
- [nginx.conf](file://nginx.conf#L60-L78)
- [netlify.toml](file://netlify.toml#L1-L23)
- [DEPLOYMENT_GUIDE.md](file://DEPLOYMENT_GUIDE.md#L1-L190)